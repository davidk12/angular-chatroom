/*! chatapp 2014-02-26 */
var app=angular.module("ChatApp",["ng","ngRoute","luegg.directives"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html",controller:"LoginController"}).when("/room/:roomName",{templateUrl:"templates/room.html",controller:"RoomController"}).otherwise({redirectTo:"/"})}]),app.factory("SocketService",["$http",function(){var a,b="";return{setConnected:function(b){a=b},setUsername:function(a){b=a},getUsername:function(){return b},getSocket:function(){return a}}}]),app.controller("LoginController",["$scope","$location","SocketService",function(a,b,c){a.username="",a.message="";var d=io.connect("http://localhost:8080");a.connect=function(){console.log("connect clicked!"),d&&d.emit("adduser",a.username,function(e){console.log("adduser: "+e),e?(console.log(a.username+" is available"),c.setConnected(d),c.setUsername(a.username),b.path("/room/lobby")):(console.log(a.username+" is NOT available"),$("#id_signup_message_div").show(),a.message="Your name is taken, please choose another",a.username=""),a.$apply()})}}]),app.controller("RoomController",["$scope","$routeParams","$location","$timeout","SocketService",function(a,b,c,d,e){a.roomName=b.roomName,a.currentMessage="",a.currentPrivateMess="",a.roomList=[],a.currentRoom="",a.roomMessages=[],a.privateMesages=[],a.selectedUser="",a.glued=!0,a.username=e.getUsername();var f=e.getSocket();f||c.path("/"),f&&(f.on("recv_privatemsg",function(b,c){a.privateMesages.push({nick:b,mess:c})}),f.emit("joinroom",{room:a.roomName},function(b,d){b?(c.path("/room/"+a.roomName),a.$apply()):console.log("Error msg Join Room: "+d)}),f.emit("rooms"),f.on("roomlist",function(b){a.roomList=b,a.$apply()}),a.create=function(){f&&f.emit("joinroom",{room:a.roomName},function(b,d){b?(c.path("/room/"+a.roomName),a.$apply()):console.log("Error msg Join Room: "+d)})},f.on("updatechat",function(b,c){a.roomMessages=c,a.filtertime(),a.$apply()}),f.on("updateusers",function(b,c){b===a.roomName&&(console.log("WANKERY"),a.users=c,a.$apply())}),a.filtertime=function(){for(var b in a.roomMessages)a.roomMessages[b].timestamp=a.roomMessages[b].timestamp.slice(11,19),console.log("wat"),a.$apply()},a.setuser=function(b){a.selectedUser=b,console.log("FUCK"+a.selectedUser)},a.send=function(){f&&(console.log("I sent a message to "+a.roomName+": "+a.currentMessage),f.emit("sendmsg",{roomName:a.roomName,msg:a.currentMessage}),a.currentMessage="")},a.keyPress=function(b){13===b.keyCode&&a.send()},a.disconnect=function(){f&&(console.log("mankeh"),f.emit("disconnect"),c.path("/"))},a.privatesend=function(){f&&(a.selectedUser==a.username?f.emit("privatemsg",{nick:a.username,message:"I suck"},function(b){a.$apply(),b&&console.log("blabla")}):""===a.selectedUser?(alert("you must select a user"),a.$apply()):f.emit("privatemsg",{nick:a.selectedUser,message:a.currentPrivateMess},function(b){a.privateMesages.push({nick:"me->"+a.selectedUser,mess:a.currentPrivateMess}),a.currentPrivateMess="",a.$apply(),b&&console.log("blabla")}),a.$apply())})}]);